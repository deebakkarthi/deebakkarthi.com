---
title: mongodb
date: 2023-11-21T04:06:27-05:00
---

# TODO
- [x] Basic queries
- [x] Concepts of Arrays
- [x] Aggregates
- [x] cursors
- [x] MapReduce
- [x] functions
- [x] innovative queries


# Implementation
## Loading dataset
![Pasted image 20231121130843](../assets/Pasted%20image%2020231121130843.png)
![Pasted image 20231121130941](../assets/Pasted%20image%2020231121130941.png)

##  Average rating per state
```js
db.business.aggregate([
    {
        $group: {
            _id: "$state",
            avgStars: { $avg: "$stars" }
        }
    }
])
```
![Pasted image 20231121131453](../assets/Pasted%20image%2020231121131453.png)

## Number of restaurants per state

```js
db.business.aggregate([
    {
        $group: {
            _id: "$state",
            count: { $sum: 1 }
        }
    },
    {
        $project: {
            _id: 0,
            state: "$_id",
            businessCount: "$count"
        }
    }
])
```

![Pasted image 20231121131947](../assets/Pasted%20image%2020231121131947.png)

## Number of distinct Restaurants
```js
db.business.aggregate([
    {
        $group: {
            _id: null,
            distinctNameCount: { $addToSet: "$name" }
        }
    },
    {
        $project: {
            _id: 0,
            distinctNameCount: { $size: "$distinctNameCount" }
        }
    }
])
```
![Pasted image 20231121132043](../assets/Pasted%20image%2020231121132043.png)

## Top Rated Restaurant in each state
```js
db.business.aggregate([
    {
        $lookup: {
            from: "business",
            let: { state: "$state", stars: "$stars" },
            pipeline: [
                {
                    $group: {
                        _id: "$state",
                        maxStars: { $max: "$stars" }
                    }
                },
                {
                    $match: {
                        $expr: {
                            $and: [
                                { $eq: ["$$state", "$_id"] },
                                { $eq: ["$$stars", "$maxStars"] }
                            ]
                        }
                    }
                }
            ],
            as: "maxStarsData"
        }
    },
    {
        $unwind: "$maxStarsData"
    },
    {
        $match: {
            $expr: {
                $and: [
                    { $eq: ["$state", "$maxStarsData._id"] },
                    { $eq: ["$stars", "$maxStarsData.maxStars"] }
                ]
            }
        }
    },
    {
        $project: {
            _id: 0,
            state: 1,
            stars: 1,
            name: 1
        }
    }
])
```
![Pasted image 20231121132144](../assets/Pasted%20image%2020231121132144.png)

# Restaurants with the most branches
```js
db.business.aggregate([
    {
        $group: {
            _id: "$name",
            locations: { $addToSet: "$address" },
            count: { $sum: 1 }
        }
    },
    {
        $match: {
            count: { $gt: 1 }
        }
    },
    {
        $sort: {
            count: -1
        }
    },
    {
        $project: {
            _id: 0,
            name: "$_id",
            locations: 1
        }
    }
])
```
![Pasted image 20231121132304](../assets/Pasted%20image%2020231121132304.png)

## Restaurants which covers the most states
```js
db.business.aggregate([
    {
        $group: {
            _id: "$name",
            uniqueStates: { $addToSet: "$state" },
            count: { $sum: 1 }
        }
    },
    {
        $match: {
            count: { $gt: 1 }
        }
    },
    {
        $sort: {
            count: 1
        }
    },
    {
        $project: {
            _id: 0,
            name: "$_id",
            state: { $size: "$uniqueStates" }
        }
    }
])
```
![Pasted image 20231121132444](../assets/Pasted%20image%2020231121132444.png)

## Number of branches per state
```js
db.business.aggregate([
    {
        $group: {
            _id: {
                name: "$name",
                state: "$state"
            },
            addressCount: { $sum: 1 }
        }
    },
    {
        $match: {
            addressCount: { $gt: 1 }
        }
    },
    {
        $sort: {
            addressCount: 1
        }
    },
    {
        $project: {
            _id: 0,
            name: "$_id.name",
            state: "$_id.state",
            address: "$addressCount"
        }
    }
])
```
![Pasted image 20231121132531](../assets/Pasted%20image%2020231121132531.png)

# Complex Queries

## Most popular user
```js
db.user.aggregate([
    {
        $project: {
            name: 1,
            nr_friends: {
                $size: {
                    $ifNull: [
                        { $split: ["$friends", ","] },
                        []
                    ]
                }
            }
        }
    },
    {
        $sort: {
            nr_friends: -1
        }
    }
])
```
![Pasted image 20231121135348](../assets/Pasted%20image%2020231121135348.png)


## Correlation Coefficient of review_count and stars

```js
db.business.aggregate([
    {
        $project: {
            stars: { $toDouble: "$stars" },
            review_count: { $toDouble: "$review_count" }
        }
    },
    {
        $group: {
            _id: null,
            review_and_stars: { $push: { stars: "$stars", review_count: "$review_count" } }
        }
    },
    {
        $project: {
            _id: 0,
            correlation: {
                $function: {
                    body: "function calculateCorrelation(a, b) {const n = a.length, m = a.reduce((s, v) => s + v, 0) / n, k = b.reduce((s, v) => s + v, 0) / n, cov = Array.from({ length: n }, (_, i) => (a[i] - m) * (b[i] - k)).reduce((s, v) => s + v, 0), var1 = a.reduce((s, v) => s + (v - m) * (v - m), 0), var2 = b.reduce((s, v) => s + (v - k) * (v - k), 0); return cov / Math.sqrt(var1 * var2);}
",
                    args: ["$review_and_stars.stars", "$review_and_stars.review_count"],
                    lang: "js"
                }
            }
        }
    }
])
```
![Pasted image 20231121140227](../assets/Pasted%20image%2020231121140227.png)

## Most visited restaurant
```js
db.checkin.aggregate([
    {
        $project: {
            business_id: 1,
            _id: 0,
            nr_visited: { $size: { $split: ["$date", ","] } }
        }
    },
    {
        $lookup: {
            from: "business",
            localField: "business_id",
            foreignField: "business_id",
            as: "business_info"
        }
    },
    {
        $unwind: "$business_info"
    },
    {
        $project: {
            _id: 0,
            name: "$business_info.name",
            nr_visited: 1
        }
    }
])
```
![Pasted image 20231121142036](../assets/Pasted%20image%2020231121142036.png)

## Which year produced the most number of elite users

```js
db.user.aggregate([
    {
        $project: {
            year: { $toInt: { $substr: ["$yelping_since", 0, 4] } },
            nr_elite: { $size: { $split: ["$elite", ','] } }
        }
    },
    {
        $group: {
            _id: "$year",
            total_nr_elite: { $sum: "$nr_elite" }
        }
    },
    {
        $sort: {
            _id: 1
        }
    }
])
```

![Pasted image 20231121142433](../assets/Pasted%20image%2020231121142433.png)


# Finding Average Star by State using MapReduce
```js
var mapFunction = function() {
    emit(this.state, { totalStars: this.stars });
};

var reduceFunction = function(key, values) {
    var reducedObject = { count: 0, totalStars: 0 };

    values.forEach(function(value) {
        reducedObject.count += 1;
        reducedObject.totalStars += value.totalStars;
    });

    reducedObject.averageStars = reducedObject.totalStars / reducedObject.count;

    return { state: key, averageStars: reducedObject.averageStars };
};

db.business.mapReduce(
    mapFunction,
    reduceFunction,
    {
        out: { inline: 1 }
    }
);

```

![Pasted image 20231121143353](../assets/Pasted%20image%2020231121143353.png)

# Cursor
```js
var cursor = db.business.find({"state": "AZ"})
while (cursor.hasNext()) { 
	var document = cursor.next();
	printjson(document);
}
```

![Pasted image 20231121143626](../assets/Pasted%20image%2020231121143626.png)